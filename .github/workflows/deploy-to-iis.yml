name: Deploy to IIS

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build -c Release --no-restore

    - name: Run tests
      run: dotnet test --no-build --verbosity normal -c Release

    - name: Publish to temp folder
      run: dotnet publish PipelinePilot.csproj -c Release -o D:\PipelinePilot\publish-temp --no-build

    - name: Update web.config for logging
      shell: powershell
      run: |
        $webConfigPath = "D:\PipelinePilot\publish-temp\web.config"
        if (Test-Path $webConfigPath) {
          $content = Get-Content $webConfigPath -Raw
          $content = $content -replace 'stdoutLogEnabled="false"', 'stdoutLogEnabled="true"'
          Set-Content -Path $webConfigPath -Value $content
          Write-Host "Updated web.config to enable logging"
        }

    - name: Stop IIS with app_offline.htm
      shell: powershell
      run: |
        $offlineFile = "D:\PipelinePilot\publish\app_offline.htm"
        "<html><body><h1>Updating...</h1></body></html>" | Out-File -FilePath $offlineFile -Encoding UTF8
        Write-Host "Created app_offline.htm - IIS will stop the app"
        Start-Sleep -Seconds 5

    - name: Copy files to IIS publish folder
      shell: powershell
      run: |
        Write-Host "Copying files from temp to publish folder..."
        Copy-Item -Path "D:\PipelinePilot\publish-temp\*" -Destination "D:\PipelinePilot\publish\" -Recurse -Force
        Write-Host "Files copied successfully"

    - name: Start IIS by removing app_offline.htm
      shell: powershell
      run: |
        $offlineFile = "D:\PipelinePilot\publish\app_offline.htm"
        if (Test-Path $offlineFile) {
          Remove-Item $offlineFile -Force
          Write-Host "Removed app_offline.htm - site is now online"
        }
        Start-Sleep -Seconds 2

    - name: Deployment Summary
      shell: powershell
      run: |
        Write-Host "Deployment Complete!"
