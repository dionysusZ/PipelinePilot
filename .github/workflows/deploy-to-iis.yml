name: Deploy to IIS

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Restore dependencies
      run: dotnet restore PipelinePilot.csproj

    - name: Build
      run: dotnet build PipelinePilot.csproj -c Release --no-restore

    - name: Create app_offline.htm to stop site
      shell: powershell
      run: |
        $offlineFile = "D:\PipelinePilot\publish\app_offline.htm"
        "Application is being updated. Please wait..." | Out-File -FilePath $offlineFile -Encoding UTF8
        Write-Host "Created app_offline.htm to stop site"
        Start-Sleep -Seconds 3

    - name: Publish to IIS folder
      run: dotnet publish PipelinePilot.csproj -c Release -o D:\PipelinePilot\publish --no-build

    - name: Update web.config for logging
      shell: powershell
      run: |
        $webConfigPath = "D:\PipelinePilot\publish\web.config"
        if (Test-Path $webConfigPath) {
          $content = Get-Content $webConfigPath -Raw
          $content = $content -replace 'stdoutLogEnabled="false"', 'stdoutLogEnabled="true"'
          Set-Content -Path $webConfigPath -Value $content
          Write-Host "Updated web.config to enable logging"
        }

    - name: Remove app_offline.htm to start site
      shell: powershell
      run: |
        $offlineFile = "D:\PipelinePilot\publish\app_offline.htm"
        if (Test-Path $offlineFile) {
          Remove-Item $offlineFile -Force
          Write-Host "Removed app_offline.htm - site is now online"
        }

    - name: Deployment Summary
      shell: powershell
      run: |
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host "Deployment Complete!" -ForegroundColor Green
        Write-Host "========================================" -ForegroundColor Cyan
        Write-Host "Published to: D:\PipelinePilot\publish" -ForegroundColor Gray
        Write-Host "Website: http://localhost:8001/weatherforecast" -ForegroundColor Cyan
        Write-Host "========================================" -ForegroundColor Cyan
